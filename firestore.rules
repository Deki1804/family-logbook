rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if authenticated user owns this user document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection structure: /users/{userId}/...
    match /users/{userId} {
      // Allow read/write to the user document itself (if it exists)
      // This allows creating/updating user metadata if needed
      allow read, write: if isOwner(userId);
      
      // Persons subcollection: /users/{userId}/persons/{personId}
      match /persons/{personId} {
        allow read, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      
      // Entities subcollection: /users/{userId}/entities/{entityId}
      match /entities/{entityId} {
        allow read, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      
      // Entries subcollection: /users/{userId}/entries/{entryId}
      match /entries/{entryId} {
        allow read, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      
      // Legacy: Children subcollection (backward compatibility)
      // /users/{userId}/children/{childId}
      match /children/{childId} {
        allow read, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      
      // Catch-all for any other subcollections (future-proofing)
      // This ensures any future subcollections work automatically
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Default deny rule for any other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

